"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[6563],{2147(e,t,n){n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"advanced/performance","title":"Performance & Optimization","description":"Understanding the Cost of Reactivity","source":"@site/docs/advanced/performance.md","sourceDirName":"advanced","slug":"/advanced/performance","permalink":"/loom/advanced/performance","draft":false,"unlisted":false,"editUrl":"https://github.com/leonieziechmann/loom/tree/main/docs/advanced/performance.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Advanced Guides","permalink":"/loom/category/advanced-guides"},"next":{"title":"Limitations & Constraints","permalink":"/loom/advanced/limitations"}}');var i=n(4848),l=n(8453);const r={sidebar_position:1},o="Performance & Optimization",d={},a=[{value:"Real-World Benchmarks",id:"real-world-benchmarks",level:2},{value:"\u26a0\ufe0f Performance Reality: Traversal vs. Execution",id:"\ufe0f-performance-reality-traversal-vs-execution",level:2},{value:"1. Traversal is Cheap (The &quot;Skip&quot; Speed)",id:"1-traversal-is-cheap-the-skip-speed",level:3},{value:"2. Reactivity is Expensive (The &quot;Logic&quot; Tax)",id:"2-reactivity-is-expensive-the-logic-tax",level:3},{value:"The &quot;Budget&quot; Rule",id:"the-budget-rule",level:2},{value:"The Cost Model",id:"the-cost-model",level:2},{value:"1. The Multi-Pass Multiplier",id:"1-the-multi-pass-multiplier",level:3},{value:"2. Context Mutation Overhead",id:"2-context-mutation-overhead",level:3},{value:"3. Recursion Limits (The Stack)",id:"3-recursion-limits-the-stack",level:3},{value:"Optimization Strategies",id:"optimization-strategies",level:2},{value:"1. Use <code>data-motif</code> for Logic",id:"1-use-data-motif-for-logic",level:3},{value:"2. Filter Early",id:"2-filter-early",level:3},{value:"3. Memoize Heavy Calculations",id:"3-memoize-heavy-calculations",level:3},{value:"4. Stabilize Quickly (Convergence)",id:"4-stabilize-quickly-convergence",level:3}];function c(e){const t={admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"performance--optimization",children:"Performance & Optimization"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"Understanding the Cost of Reactivity"})}),"\n",(0,i.jsx)(t.p,{children:'Loom brings powerful capabilities to Typst, but "Time Travel" comes at a cost. Because Loom runs your document logic multiple times to resolve dependencies, it will always be slower than a standard, linear Typst document.'}),"\n",(0,i.jsx)(t.p,{children:"This guide explains where that time goes and how to keep your documents fast."}),"\n",(0,i.jsx)(t.h2,{id:"real-world-benchmarks",children:"Real-World Benchmarks"}),"\n",(0,i.jsx)(t.p,{children:"To give you a realistic idea of Loom's overhead, here are compilation times from our test suite."}),"\n",(0,i.jsx)(t.admonition,{title:"The Verdict",type:"info",children:(0,i.jsxs)(t.p,{children:["Loom is ",(0,i.jsx)(t.strong,{children:"efficient at doing nothing"})," (skipping standard content) but ",(0,i.jsx)(t.strong,{children:"expensive when engaged"})," (processing logic)."]})}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Scenario"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Complexity"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Time"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Verdict"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"Baseline Traversal"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"3,000 standard nodes, no motifs."}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"~200ms"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["\ud83d\ude80 ",(0,i.jsx)(t.strong,{children:"Fast"})]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"External Wrappers"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Shallow nesting, wrapping ",(0,i.jsx)(t.code,{children:"cetz"})," or ",(0,i.jsx)(t.code,{children:"codly"}),"."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"~2.3ms"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["\u26a1 ",(0,i.jsx)(t.strong,{children:"Negligible"})]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"Recipe Showcase"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Real-world document, ~20 data nodes."}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"~16ms"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["\ud83d\ude80 ",(0,i.jsx)(t.strong,{children:"Fast"})]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"The Legion"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"2,000+ active motifs, 500+ context mutations."}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"~7.8s"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["\ud83d\udd34 ",(0,i.jsx)(t.strong,{children:"Heavy"})]})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"\ufe0f-performance-reality-traversal-vs-execution",children:"\u26a0\ufe0f Performance Reality: Traversal vs. Execution"}),"\n",(0,i.jsxs)(t.p,{children:["Loom's performance profile is split into two distinct categories: ",(0,i.jsx)(t.strong,{children:"Traversal Overhead"})," (skipping standard content) and ",(0,i.jsx)(t.strong,{children:"Reactive Cost"})," (processing Motifs)."]}),"\n",(0,i.jsx)(t.h3,{id:"1-traversal-is-cheap-the-skip-speed",children:'1. Traversal is Cheap (The "Skip" Speed)'}),"\n",(0,i.jsxs)(t.p,{children:["Benchmarks show that Loom can traverse ",(0,i.jsx)(t.strong,{children:"30,000+ standard nodes"})," (like ",(0,i.jsx)(t.code,{children:"text"}),", ",(0,i.jsx)(t.code,{children:"block"}),", ",(0,i.jsx)(t.code,{children:"place"}),") in roughly ",(0,i.jsx)(t.strong,{children:"1.7s"}),"."]}),"\n",(0,i.jsx)(t.admonition,{title:"Implication",type:"tip",children:(0,i.jsx)(t.p,{children:"You do not need to worry about the length of your text chapters. Loom efficiently ignores content that isn't part of its system. A 50-page thesis full of standard paragraphs will not incur a significant penalty."})}),"\n",(0,i.jsx)(t.h3,{id:"2-reactivity-is-expensive-the-logic-tax",children:'2. Reactivity is Expensive (The "Logic" Tax)'}),"\n",(0,i.jsxs)(t.p,{children:["However, once you introduce a ",(0,i.jsx)(t.code,{children:"motif"}),", the engine must allocate a Frame, track its path, and manage its signals. While you can have 10,000 standard nodes, you ",(0,i.jsx)(t.strong,{children:"cannot"})," have 10,000 Motifs. In stress tests, 2,000 active Motifs with context mutations slowed compilation to ",(0,i.jsx)(t.strong,{children:"~8 seconds"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"the-budget-rule",children:'The "Budget" Rule'}),"\n",(0,i.jsx)(t.p,{children:'Think of Loom like a game engine. You have a "polygon budget" (Motifs) and a "texture budget" (Context).'}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Component Type"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Cost"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Recommended Budget"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"Standard Typst"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"\ud83d\udfe2 Very Low"}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,i.jsx)(t.strong,{children:"Unlimited"})," (within Typst's own limits)"]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"Data Motifs"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"\ud83d\udfe1 Moderate"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Use for structure (Sections, Ingredients), not data points."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"Active Motifs"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"\ud83d\udd34 High"}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,i.jsx)(t.strong,{children:"< 500 per document."})," Use sparingly for high-level logic."]})]})]})]}),"\n",(0,i.jsx)(t.admonition,{title:"Design Principle",type:"warning",children:(0,i.jsxs)(t.p,{children:["Loom is designed to manage the ",(0,i.jsx)(t.strong,{children:"skeleton"})," of your document (Sections, Headers, Totals). Do not use it to manage the ",(0,i.jsx)(t.strong,{children:"flesh"})," (individual table cells, list bullets, or character primitives)."]})}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsx)(t.h2,{id:"the-cost-model",children:"The Cost Model"}),"\n",(0,i.jsx)(t.p,{children:"The compilation time of a Loom document can be roughly estimated as:"}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"Time \u2248 (Node Count + Context Complexity) \xd7 (Passes)"})}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"1-the-multi-pass-multiplier",children:"1. The Multi-Pass Multiplier"}),"\n",(0,i.jsxs)(t.p,{children:["Loom runs the ",(0,i.jsx)(t.code,{children:"measure"})," phase in a loop."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Default:"})," 2 Passes (1 Measure + 1 Draw)."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Complex:"})," If you set ",(0,i.jsx)(t.code,{children:"max-passes: 5"}),", loom takes ~2.5x longer."]}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{title:"Optimization Tip",type:"tip",children:(0,i.jsxs)(t.p,{children:["Keep ",(0,i.jsx)(t.code,{children:"max-passes"})," as low as possible. Most documents only need 2 or 3 passes. Only increase it if you have deep dependency chains (e.g., A needs B, which needs C, which needs D)."]})}),"\n",(0,i.jsx)(t.h3,{id:"2-context-mutation-overhead",children:"2. Context Mutation Overhead"}),"\n",(0,i.jsxs)(t.p,{children:["Typst dictionaries are ",(0,i.jsx)(t.strong,{children:"immutable"}),". Every time you use ",(0,i.jsx)(t.code,{children:"scope"})," to inject a variable (e.g., ",(0,i.jsx)(t.code,{children:'ctx + (theme: "dark")'}),"), the engine must create a ",(0,i.jsx)(t.em,{children:"copy"})," of the context dictionary."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Cheap:"})," Reading values (",(0,i.jsx)(t.code,{children:'ctx.at("key")'}),")."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Expensive:"})," Writing values deeply nested in the tree for every single child."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"3-recursion-limits-the-stack",children:"3. Recursion Limits (The Stack)"}),"\n",(0,i.jsxs)(t.p,{children:["Loom's ",(0,i.jsx)(t.code,{children:"intertwine"})," engine is recursive, and Typst has a fixed stack size. The limit is approximately ",(0,i.jsx)(t.strong,{children:"50-60 levels"})," of nesting."]}),"\n",(0,i.jsxs)(t.admonition,{title:"Stack Overflow",type:"danger",children:[(0,i.jsxs)(t.p,{children:["If you nest components too deeply (e.g., ",(0,i.jsx)(t.code,{children:"block > block > ... > block"}),"), the compiler will panic."]}),(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Best Practice:"})," Flatten your structure where possible. Loom is designed for document architecture, not for rendering fractals or pixel-level grids."]})]}),"\n",(0,i.jsx)(t.h2,{id:"optimization-strategies",children:"Optimization Strategies"}),"\n",(0,i.jsxs)(t.h3,{id:"1-use-data-motif-for-logic",children:["1. Use ",(0,i.jsx)(t.code,{children:"data-motif"})," for Logic"]}),"\n",(0,i.jsxs)(t.p,{children:["If a component exists only to calculate data (like an ",(0,i.jsx)(t.code,{children:"ingredient"})," or a ",(0,i.jsx)(t.code,{children:"metadata"})," tag), always use ",(0,i.jsx)(t.code,{children:"data-motif"}),"."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["It has no ",(0,i.jsx)(t.code,{children:"draw"})," phase (returns ",(0,i.jsx)(t.code,{children:"none"})," immediately), saving layout time in the final pass."]}),"\n",(0,i.jsxs)(t.li,{children:["It avoids processing a ",(0,i.jsx)(t.code,{children:"body"})," content block."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"2-filter-early",children:"2. Filter Early"}),"\n",(0,i.jsxs)(t.p,{children:["In your ",(0,i.jsx)(t.code,{children:"measure"})," function, use ",(0,i.jsx)(t.code,{children:"query.select"})," or ",(0,i.jsx)(t.code,{children:"query.find"})," to narrow down the children you process. Avoid mapping over ",(0,i.jsx)(t.em,{children:"all"})," ",(0,i.jsx)(t.code,{children:"children"}),' if you only need the "tasks".']}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typ",children:'// \u2705 Fast: Only look at relevant signals\n#let tasks = query.select(children, "task")\n\n// \u26a0\ufe0f Slower: Iterating everything unnecessarily\n#let everything = children.map(c => process-heavy-logic(c))\n'})}),"\n",(0,i.jsx)(t.h3,{id:"3-memoize-heavy-calculations",children:"3. Memoize Heavy Calculations"}),"\n",(0,i.jsxs)(t.p,{children:["If you have a heavy function (e.g., generating a complex chart), try to ensure it only runs in the ",(0,i.jsx)(t.strong,{children:"Final Draw Pass"}),", not during the Measure passes. The ",(0,i.jsx)(t.code,{children:"measure"})," phase should only calculate ",(0,i.jsx)(t.em,{children:"metadata"})," (sizes, prices, counts)."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typ",children:"// \u2705 Good Separation\nmeasure: (ctx, _) => ( (price: 10), (price: 10) ), // Fast signal\ndraw: (ctx, _, view, _) => {\n  // Expensive chart generation happens ONCE here\n  cetz.canvas(...)\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"4-stabilize-quickly-convergence",children:"4. Stabilize Quickly (Convergence)"}),"\n",(0,i.jsx)(t.p,{children:"Ensure your signals stabilize as fast as possible."}),"\n",(0,i.jsx)(t.admonition,{title:"Convergence",type:"note",children:(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Bad:"})," A signal that toggles between ",(0,i.jsx)(t.code,{children:"true"})," and ",(0,i.jsx)(t.code,{children:"false"})," every pass. This forces Loom to run until ",(0,i.jsx)(t.code,{children:"max-passes"})," is hit."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Good:"})," A signal that settles on a value in Pass 2 and stays there."]}),"\n"]})})]})}function h(e={}){const{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453(e,t,n){n.d(t,{R:()=>r,x:()=>o});var s=n(6540);const i={},l=s.createContext(i);function r(e){const t=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(l.Provider,{value:t},e.children)}}}]);