"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[9440],{8254(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"concepts/pattern-enforcer","title":"Pattern: The Enforcer","description":"Building Crash-Proof Templates with Guards","source":"@site/docs/concepts/pattern-enforcer.md","sourceDirName":"concepts","slug":"/concepts/pattern-enforcer","permalink":"/loom/canary/concepts/pattern-enforcer","draft":false,"unlisted":false,"editUrl":"https://github.com/leonieziechmann/loom/tree/main/docs/docs/concepts/pattern-enforcer.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"tutorialSidebar","previous":{"title":"Pattern: The Aggregator","permalink":"/loom/canary/concepts/pattern-aggregator"},"next":{"title":"Showcase","permalink":"/loom/canary/category/showcase"}}');var r=s(4848),i=s(8453);const o={sidebar_position:6},a="Pattern: The Enforcer",d={},c=[{value:"The Problem: &quot;Silent Failures&quot;",id:"the-problem-silent-failures",level:2},{value:"The Solution: Guards",id:"the-solution-guards",level:2},{value:"1. Hierarchy Guards (Strict Nesting)",id:"1-hierarchy-guards-strict-nesting",level:3},{value:"2. Context Guards (Required Data)",id:"2-context-guards-required-data",level:3},{value:"3. Root Guards (Singletons)",id:"3-root-guards-singletons",level:3},{value:"Available Guards",id:"available-guards",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"&quot;Fail Loud&quot; vs. &quot;Adapt&quot;",id:"fail-loud-vs-adapt",level:3},{value:"Guard the <code>measure</code> phase",id:"guard-the-measure-phase",level:3}];function l(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"pattern-the-enforcer",children:"Pattern: The Enforcer"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Building Crash-Proof Templates with Guards"})}),"\n",(0,r.jsxs)(n.p,{children:["So far, we have talked about how to share data (Providers) and collect data (Aggregators). But what happens when a user uses your components ",(0,r.jsx)(n.strong,{children:"wrong"}),"?"]}),"\n",(0,r.jsxs)(n.p,{children:["What if they put a ",(0,r.jsx)(n.code,{children:"TableCell"})," inside a ",(0,r.jsx)(n.code,{children:"Footnote"}),"? Or try to use a ",(0,r.jsx)(n.code,{children:"Chapter"})," without a ",(0,r.jsx)(n.code,{children:"Book"}),' wrapper? In standard Typst, this often leads to "Silent Failures"\u2014the content just renders weirdly, or variables are missing, and the user has no idea why.']}),"\n",(0,r.jsxs)(n.p,{children:["Loom solves this with the ",(0,r.jsx)(n.strong,{children:"Enforcer Pattern"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"the-problem-silent-failures",children:'The Problem: "Silent Failures"'}),"\n",(0,r.jsxs)(n.p,{children:["Imagine you are building a slideshow template. You have a ",(0,r.jsx)(n.code,{children:"slide"})," component that expects to be inside a ",(0,r.jsx)(n.code,{children:"presentation"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"The Unsafe Way:"}),"\nIf a user pastes a ",(0,r.jsx)(n.code,{children:"#slide[...]"})," into a normal document, it might try to read ",(0,r.jsx)(n.code,{children:"ctx.page-width"})," (which doesn't exist) and crash with a cryptic error: ",(0,r.jsx)(n.em,{children:"\"key 'page-width' not found in dictionary.\""})]}),"\n",(0,r.jsx)(n.p,{children:"Or worse, it might render perfectly fine, but look completely broken because it's missing the styling from the root."}),"\n",(0,r.jsx)(n.h2,{id:"the-solution-guards",children:"The Solution: Guards"}),"\n",(0,r.jsxs)(n.p,{children:["Loom provides a ",(0,r.jsx)(n.code,{children:"guards"})," module that allows your components to assert where they are allowed to live. If the rules are violated, Loom stops the compilation with a ",(0,r.jsx)(n.strong,{children:"clear, helpful error message"}),"."]}),"\n",(0,r.jsx)(n.p,{children:'This turns a "runtime bug" into a "usage instruction."'}),"\n",(0,r.jsx)(n.h3,{id:"1-hierarchy-guards-strict-nesting",children:"1. Hierarchy Guards (Strict Nesting)"}),"\n",(0,r.jsx)(n.p,{children:"The most common check is enforcing parent-child relationships."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typ",children:'#import "@preview/loom:0.1.0": *\n#let (motif, weave, context, guards) = construct-loom(<my-lib>)\n\n// CHILD: Ingredient\n#let ingredient(name) = motif(\n  measure: (ctx, _) => {\n    // RULE: I MUST be inside a \'recipe\' component.\n    // If not, stop compilation immediately.\n    guards.assert-inside(ctx, "recipe")\n\n    ( (name: name), none )\n  },\n  draw: (ctx, public, view, body) => [ - #name ]\n)\n\n// PARENT: Recipe\n// We give this component the specific name "recipe"\n#let recipe(name, body) = motif(name: "recipe",\n  draw: (ctx, public, view, body) => block(body),\n  body\n)\n'})}),"\n",(0,r.jsx)(n.p,{children:"Now, if a user tries this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typ",children:"#ingredient(\"Salt\") // \u274c ERROR: Component must be inside 'recipe'.\n"})}),"\n",(0,r.jsx)(n.p,{children:"They get a clear message telling them exactly what they did wrong."}),"\n",(0,r.jsx)(n.h3,{id:"2-context-guards-required-data",children:"2. Context Guards (Required Data)"}),"\n",(0,r.jsxs)(n.p,{children:["Sometimes, you don't care ",(0,r.jsx)(n.em,{children:"where"})," a component is, but you care ",(0,r.jsx)(n.em,{children:"what"})," data it has.\nWhile the ",(0,r.jsx)(n.strong,{children:"Provider Pattern"})," suggests using defaults (",(0,r.jsx)(n.code,{children:"auto"}),"), some components simply cannot function without specific data."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typ",children:'#let plot-point(x, y) = data-motif(\n  "plot-point",\n  measure: (ctx) => {\n    // RULE: The coordinate system MUST be defined.\n    // We can\'t default this; if it\'s missing, the plot is invalid.\n    guards.assert-has-key(ctx, "plot-axis-x")\n    guards.assert-has-key(ctx, "plot-axis-y")\n\n    (x: x, y: y)\n  },\n  // ...\n)\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3-root-guards-singletons",children:"3. Root Guards (Singletons)"}),"\n",(0,r.jsxs)(n.p,{children:["Some components only make sense if they are the ",(0,r.jsx)(n.strong,{children:"Director"})," (the root of the Loom weave). For example, a ",(0,r.jsx)(n.code,{children:"book"})," or ",(0,r.jsx)(n.code,{children:"presentation"})," wrapper."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typ",children:'#let presentation(body) = manged-motif(\n  "presentation",\n  measure: (ctx, _) => {\n    // RULE: I must be the top-level component.\n    guards.assert-root(ctx)\n    // ...\n  },\n  body\n)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"available-guards",children:"Available Guards"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"loom.guards"})," module covers the most common architectural constraints:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Guard"}),(0,r.jsx)(n.th,{children:"Checks For..."}),(0,r.jsx)(n.th,{children:"Use Case"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"assert-inside(ctx, ..names)"})}),(0,r.jsx)(n.td,{children:"Ancestor existence"}),(0,r.jsx)(n.td,{children:'"Slide must be in Presentation"'})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"assert-not-inside(ctx, ..names)"})}),(0,r.jsx)(n.td,{children:"Ancestor absence"}),(0,r.jsx)(n.td,{children:'"Don\'t put a Chapter inside a Footer"'})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"assert-direct-parent(ctx, ..names)"})}),(0,r.jsx)(n.td,{children:"Immediate parent"}),(0,r.jsx)(n.td,{children:'"Tab Item must be directly in Tabs"'})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"assert-root(ctx)"})}),(0,r.jsx)(n.td,{children:"Being the root"}),(0,r.jsx)(n.td,{children:"Top-level wrappers"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"assert-has-key(ctx, key)"})}),(0,r.jsx)(n.td,{children:"Context data"}),(0,r.jsx)(n.td,{children:"Mandatory configuration"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"assert-max-depth(ctx, n)"})}),(0,r.jsx)(n.td,{children:"Nesting limits"}),(0,r.jsx)(n.td,{children:"Preventing infinite recursion"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"fail-loud-vs-adapt",children:'"Fail Loud" vs. "Adapt"'}),"\n",(0,r.jsx)(n.p,{children:"You now have two opposing patterns:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Provider Pattern:"}),' "If data is missing, use a default." (Adapt)']}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Enforcer Pattern:"}),' "If data is missing, crash." (Fail Loud)']}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"When to use which?"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use Enforcers"})," when the usage is ",(0,r.jsx)(n.strong,{children:"invalid"}),". (e.g., A ",(0,r.jsx)(n.code,{children:"TabItem"})," outside of ",(0,r.jsx)(n.code,{children:"Tabs"})," makes no sense logically)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use Providers"})," when the usage is ",(0,r.jsx)(n.strong,{children:"optional"}),". (e.g., A ",(0,r.jsx)(n.code,{children:"Button"})," outside of a ",(0,r.jsx)(n.code,{children:"Theme"})," should just look boring, not crash)."]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"guard-the-measure-phase",children:["Guard the ",(0,r.jsx)(n.code,{children:"measure"})," phase"]}),"\n",(0,r.jsxs)(n.p,{children:["Always place your guards in the ",(0,r.jsx)(n.code,{children:"measure"})," function, not ",(0,r.jsx)(n.code,{children:"draw"}),"."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"measure"})," runs first, so the error happens sooner."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"measure"})," is used for logic; ",(0,r.jsx)(n.code,{children:"draw"})," should be safe and dumb."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typ",children:'// \u2705 Good\nmeasure: (ctx, _) => {\n  guards.assert-inside(ctx, "list")\n  // ...\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453(e,n,s){s.d(n,{R:()=>o,x:()=>a});var t=s(6540);const r={},i=t.createContext(r);function o(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);